name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build:
    name: Build & Lint
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Typecheck
        run: pnpm check-types

      - name: Lint
        run: pnpm lint

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Run unit tests
        run: |
          pnpm --filter @saga-bus/core test
          pnpm --filter @saga-bus/test test
          pnpm --filter @saga-bus/transport-inmemory test
          pnpm --filter @saga-bus/store-inmemory test
          pnpm --filter @saga-bus/store-prisma test
          pnpm --filter @saga-bus/middleware-logging test
          pnpm --filter @saga-bus/middleware-tracing test
          pnpm --filter @saga-bus/middleware-metrics test
          pnpm --filter @saga-bus/middleware-validation test
          pnpm --filter @saga-bus/middleware-idempotency test
          pnpm --filter @saga-bus/middleware-tenant test
          pnpm --filter @saga-bus/nestjs test
          pnpm --filter @saga-bus/nextjs test
          pnpm --filter @saga-bus/express test
          pnpm --filter @saga-bus/fastify test
          pnpm --filter @saga-bus/hono test

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      # Cache Docker images for testcontainers
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-

      # Pull common testcontainer images in parallel
      - name: Pre-pull Docker images
        run: |
          docker pull postgres:15-alpine &
          docker pull rabbitmq:3-management-alpine &
          docker pull mongo:7 &
          docker pull confluentinc/cp-kafka:7.5.0 &
          docker pull localstack/localstack:latest &
          wait

      - name: Run PostgreSQL store tests
        run: pnpm --filter @saga-bus/store-postgres test

      - name: Run RabbitMQ transport tests
        run: pnpm --filter @saga-bus/transport-rabbitmq test

      - name: Run MongoDB store tests
        run: pnpm --filter @saga-bus/store-mongo test

      - name: Run Kafka transport tests
        run: pnpm --filter @saga-bus/transport-kafka test

      - name: Run DynamoDB store tests
        run: pnpm --filter @saga-bus/store-dynamodb test

      - name: Run SQS transport tests
        run: pnpm --filter @saga-bus/transport-sqs test
